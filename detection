"""
AI Proctoring System for Exams
Uses OpenCV for real-time monitoring of exam takers
Features: Face detection, eye tracking, multiple person detection, head pose estimation
"""

import cv2
import numpy as np
import time
from datetime import datetime
import os


class AIProctorSystem:
    def __init__(self):
        # Load pre-trained Haar Cascade classifiers
        self.face_casqcade = cv2.CascadeClassifier(cv2.data.haarcascades + 'haarcascade_frontalface_default.xml')
        self.eye_cascade = cv2.CascadeClassifier(cv2.data.haarcascades + 'haarcascade_eye.xml')

        # Violation tracking
        self.violations = {
            'no_face': 0,
            'multiple_faces': 0,
            'no_eyes': 0,
            'looking_away': 0
        }

        # Timing
        self.start_time = time.time()
        self.last_violation_time = time.time()

        # Thresholds
        self.face_timeout = 3  # seconds without face before violation
        self.eye_timeout = 2  # seconds without eyes before violation

        # Create logs directory
        if not os.path.exists('proctoring_logs'):
            os.makedirs('proctoring_logs')

        # Screenshot directory
        if not os.path.exists('violations'):
            os.makedirs('violations')

    def detect_face_and_eyes(self, frame):
        """Detect faces and eyes in the frame"""
        gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)

        # Detect faces
        faces = self.face_cascade.detectMultiScale(
            gray,
            scaleFactor=1.1,
            minNeighbors=5,
            minSize=(100, 100)
        )

        eyes_detected = False

        # Process each face
        for (x, y, w, h) in faces:
            # Draw rectangle around face
            cv2.rectangle(frame, (x, y), (x + w, y + h), (0, 255, 0), 2)

            # Region of interest for eyes (upper half of face)
            roi_gray = gray[y:y + int(h / 2), x:x + w]
            roi_color = frame[y:y + int(h / 2), x:x + w]

            # Detect eyes
            eyes = self.eye_cascade.detectMultiScale(
                roi_gray,
                scaleFactor=1.1,
                minNeighbors=10,
                minSize=(20, 20)
            )

            # Draw rectangles around eyes
            for (ex, ey, ew, eh) in eyes:
                cv2.rectangle(roi_color, (ex, ey), (ex + ew, ey + eh), (255, 0, 0), 2)

            if len(eyes) >= 2:
                eyes_detected = True

        return frame, len(faces), eyes_detected

    def log_violation(self, violation_type, frame):
        """Log violations and save screenshots"""
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")

        # Save screenshot
        filename = f"violations/{violation_type}_{timestamp}.jpg"
        cv2.imwrite(filename, frame)

        # Update violation count
        self.violations[violation_type] += 1

        # Log to file
        with open('proctoring_logs/violations.log', 'a') as f:
            f.write(f"{datetime.now()}: {violation_type} - Screenshot saved: {filename}\n")

        print(f"⚠️  VIOLATION: {violation_type}")

    def draw_status(self, frame, face_count, eyes_detected):
        """Draw status information on frame"""
        height, width = frame.shape[:2]

        # Create status overlay
        overlay = frame.copy()
        cv2.rectangle(overlay, (10, 10), (400, 180), (0, 0, 0), -1)
        frame = cv2.addWeighted(overlay, 0.6, frame, 0.4, 0)

        # Time elapsed
        elapsed = int(time.time() - self.start_time)
        minutes = elapsed // 60
        seconds = elapsed % 60

        # Status text
        cv2.putText(frame, "AI PROCTORING SYSTEM", (20, 35),
                    cv2.FONT_HERSHEY_SIMPLEX, 0.7, (255, 255, 255), 2)
        cv2.putText(frame, f"Time: {minutes:02d}:{seconds:02d}", (20, 65),
                    cv2.FONT_HERSHEY_SIMPLEX, 0.6, (255, 255, 255), 1)

        # Face status
        if face_count == 0:
            face_status = "NO FACE DETECTED"
            face_color = (0, 0, 255)
        elif face_count == 1:
            face_status = "FACE DETECTED"
            face_color = (0, 255, 0)
        else:
            face_status = f"MULTIPLE FACES ({face_count})"
            face_color = (0, 0, 255)

        cv2.putText(frame, face_status, (20, 95),
                    cv2.FONT_HERSHEY_SIMPLEX, 0.6, face_color, 2)

        # Eye status
        eye_status = "EYES DETECTED" if eyes_detected else "EYES NOT DETECTED"
        eye_color = (0, 255, 0) if eyes_detected else (0, 0, 255)
        cv2.putText(frame, eye_status, (20, 125),
                    cv2.FONT_HERSHEY_SIMPLEX, 0.6, eye_color, 2)

        # Violation count
        total_violations = sum(self.violations.values())
        cv2.putText(frame, f"Violations: {total_violations}", (20, 155),
                    cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 255, 255), 2)

        return frame

    def check_violations(self, face_count, eyes_detected, frame):
        """Check for various violations"""
        current_time = time.time()

        # No face detected
        if face_count == 0:
            if current_time - self.last_violation_time > self.face_timeout:
                self.log_violation('no_face', frame)
                self.last_violation_time = current_time

        # Multiple faces detected
        elif face_count > 1:
            self.log_violation('multiple_faces', frame)
            self.last_violation_time = current_time

        # Eyes not detected (looking away)
        elif not eyes_detected:
            if current_time - self.last_violation_time > self.eye_timeout:
                self.log_violation('looking_away', frame)
                self.last_violation_time = current_time

    def generate_report(self):
        """Generate final proctoring report"""
        elapsed = int(time.time() - self.start_time)
        minutes = elapsed // 60
        seconds = elapsed % 60

        report = f"""
{'=' * 50}
AI PROCTORING SYSTEM - EXAM REPORT
{'=' * 50}
Exam Duration: {minutes:02d}:{seconds:02d}

VIOLATIONS SUMMARY:
- No Face Detected: {self.violations['no_face']}
- Multiple Faces: {self.violations['multiple_faces']}
- Looking Away: {self.violations['looking_away']}

Total Violations: {sum(self.violations.values())}
{'=' * 50}
"""

        print(report)

        # Save report
        with open('proctoring_logs/exam_report.txt', 'w') as f:
            f.write(report)

    def run(self):
        """Main proctoring loop"""
        print("Starting AI Proctoring System...")
        print("Press 'q' to quit")

        # Initialize webcam
        cap = cv2.VideoCapture(0)

        if not cap.isOpened():
            print("Error: Could not open webcam")
            return

        # Set resolution
        cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
        cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)

        print("Proctoring started. Monitoring exam...")

        try:
            while True:
                ret, frame = cap.read()

                if not ret:
                    print("Error: Could not read frame")
                    break

                # Detect face and eyes
                processed_frame, face_count, eyes_detected = self.detect_face_and_eyes(frame)

                # Check for violations
                self.check_violations(face_count, eyes_detected, processed_frame)

                # Draw status overlay
                processed_frame = self.draw_status(processed_frame, face_count, eyes_detected)

                # Display frame
                cv2.imshow('AI Proctoring System', processed_frame)

                # Check for quit key
                if cv2.waitKey(1) & 0xFF == ord('q'):
                    print("\nExam ended by user")
                    break

        finally:
            # Cleanup
            cap.release()
            cv2.destroyAllWindows()

            # Generate final report
            self.generate_report()


def main():
    """Main entry point"""
    print("""
    ╔════════════════════════════════════════╗
    ║   AI PROCTORING SYSTEM FOR EXAMS      ║
    ║   Using OpenCV & Computer Vision      ║
    ╚════════════════════════════════════════╝

    Features:
    ✓ Real-time face detection
    ✓ Eye tracking
    ✓ Multiple person detection
    ✓ Violation logging with screenshots
    ✓ Automated exam report

    """)

    proctor = AIProctorSystem()
    proctor.run()


if __name__ == "__main__":
    main()
